pipeline {
    agent any

    stages {
        def alluredir = 'allure results'

        stage('Setup parameters') {
            steps {
                script {                     
                    properties([
                        parameters([
                            choice(
                                choices: ['chrome', 'firefox', 'opera'], 
                                name: 'BROWSER'
                            ),
                            choice(
                                choices: ['last_stable', 'y', 'x'], 
                                name: 'BROWSER_VESION'
                            ),
                            string(
                                defaultValue: '', 
                                name: 'EXECUTOR_URL', 
                                trim: true
                            ),
                            string(
                                defaultValue: '', 
                                name: 'TARGET_APP_URL', 
                                trim: true
                            )
                        ])
                    ])
                }
            }
        }
        stage('test') {
            steps {
              sh """
                  PATH=$PATH:$WORKSPACE
                  python3 -m venv venv
                  . venv/bin/activate
                  pip3 install -r requirements.txt
                  pytest -v tests/test_opencart.py --junitxml=report.xml --url=$TARGET_APP_URL --browser=$BROWSER --executor=$EXECUTOR_URL --alluredir=${alluredir}
                """
            }
        }
        stage('report-xml') {
            steps {
                junit 'report.xml'
            }
        }
        stage('report-allure') {
            steps {
                script {
                    allure([
                        includeProperties: false,
                        jdk: '',
                        properties: [],
                        reportBuildPolicy: 'ALWAYS',
                        results: [[path: alluredir]]
                    ])
                }
            }
        }
    }
}
